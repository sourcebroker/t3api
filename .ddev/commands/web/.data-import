#!/bin/bash

## Description: T3api - import data/files with ext:impexp.
## Usage: import
## Example: "ddev import 12"

source .ddev/test/utils.sh

TYPO3=${1}
if ! check_typo3_version "$TYPO3"; then
    exit 1
fi

BASE_PATH=/var/www/html/.test/$TYPO3
TYPO3_BIN=$BASE_PATH/vendor/bin/typo3
DATABASE=database_$TYPO3

OUTPUT_FILE="/var/www/html/.test/${TYPO3}/public/fileadmin/user_upload/_temp_/importexport/"
rm -rf $OUTPUT_FILE*

cp -r /var/www/html/.ddev/test/impexp/* $OUTPUT_FILE/

mysql -uroot -proot -Nse 'SHOW TABLES' "$DATABASE" | while read table; do
  if [ "$table" != "be_users" ] && [ "$table" != "be_sessions" ]; then
    mysql -uroot -proot -e "SET FOREIGN_KEY_CHECKS = 0; DROP TABLE IF EXISTS $table" "$DATABASE";
  fi
done
$TYPO3_BIN database:updateschema

/var/www/html/.test/${TYPO3}/vendor/bin/typo3 impexp:import -vvv --force-uid fileadmin/user_upload/_temp_/importexport/t3api.xml
