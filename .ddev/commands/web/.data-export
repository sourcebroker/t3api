#!/bin/bash

## Description: T3api - export data/files with ext:impexp.
## Usage: export
## Example: "ddev export 12"

source .ddev/test/utils.sh

TYPO3=${1}
if ! check_typo3_version "$TYPO3"; then
    exit 1
fi
DATABASE="database_$TYPO3"
TYPO3_BIN=/var/www/html/.test/$TYPO3/vendor/bin/typo3

# cleanup database tables before export
$TYPO3_BIN cleanup:missingrelations --update-refindex
$TYPO3_BIN cleanup:flexforms
$TYPO3_BIN cleanup:deletedrecords
$TYPO3_BIN cleanup:orphanrecords
echo "DELETE sys_file_metadata FROM sys_file_metadata LEFT JOIN sys_file ON sys_file_metadata.file = sys_file.uid WHERE sys_file.uid IS NULL;" | mysql -uroot -proot "$DATABASE"
echo "DELETE sys_file_metadata FROM sys_file_metadata INNER JOIN sys_file ON sys_file_metadata.file = sys_file.uid WHERE sys_file.identifier LIKE '/user_upload/_temp_/%' OR sys_file.identifier LIKE '%index.html' OR identifier LIKE '/user_upload/news-media/%';" | mysql -uroot -proot "$DATABASE"
echo "DELETE FROM sys_file WHERE identifier LIKE '/user_upload/_temp_/%' OR identifier LIKE '%index.html' OR identifier LIKE '/user_upload/news-media/%';" | mysql -uroot -proot "$DATABASE"
echo 'TRUNCATE sys_history; TRUNCATE sys_log; TRUNCATE be_sessions; TRUNCATE fe_sessions; TRUNCATE fe_sessions; TRUNCATE sys_file_processedfile; TRUNCATE sys_lockedrecords; TRUNCATE tx_extensionmanager_domain_model_extension;' | mysql -uroot -proot "$DATABASE"
echo "SELECT concat('TRUNCATE TABLE ', TABLE_NAME, ';') FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = '$DATABASE' AND TABLE_NAME LIKE 'cache%'" | mysql -uroot -proot "$DATABASE" | sed 1d > tmp.sql
mysql -uroot -proot "$DATABASE" < tmp.sql
rm tmp.sql

# be_users excluded because of problems on import
/var/www/html/.test/${TYPO3}/vendor/bin/typo3 impexp:export -vvv \
                                                --type=xml \
                                                --pid=0 \
                                                --levels=99 \
                                                --table=backend_layout \
                                                --table=be_groups \
                                                --table=fe_groups \
                                                --table=fe_users \
                                                --table=sys_category \
                                                --table=sys_file \
                                                --table=sys_file_collection \
                                                --table=sys_file_metadata \
                                                --table=sys_file_reference \
                                                --table=sys_file_storage \
                                                --table=sys_filemounts \
                                                --table=sys_log \
                                                --table=sys_news \
                                                --table=sys_template \
                                                --table=tt_content \
                                                --table=tx_news_domain_model_news \
                                                --table=tx_news_domain_model_link \
                                                --table=tx_news_domain_model_tag \
                                                --include-related=_ALL \
                                                --include-static=_ALL \
                                                --save-files-outside-export-file \
                                                t3api

OUTPUT_FILE="/var/www/html/.test/${TYPO3}/public/fileadmin/user_upload/_temp_/importexport/"
rm -rf /var/www/html/.ddev/test/impexp
mkdir -p /var/www/html/.ddev/test/impexp
mv $OUTPUT_FILE/t3api.xml /var/www/html/.ddev/test/impexp
mv $OUTPUT_FILE/t3api.xml.files/ /var/www/html/.ddev/test/impexp

echo_green "Dump finished and saved at $OUTPUT_FILE"
